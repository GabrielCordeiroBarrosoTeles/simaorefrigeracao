#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

$container = require __DIR__ . '/../src/bootstrap.php';
$entityManager = $container->get('doctrine.entity_manager');

use App\Domain\Entity\Cliente;
use App\Domain\Entity\ClienteTipo;
use App\Domain\Entity\Servico;
use App\Domain\Entity\Tecnico;
use App\Domain\ValueObject\Email;
use App\Domain\ValueObject\Telefone;

echo "Carregando fixtures...\n";

// Clientes
$clientesData = require __DIR__ . '/DataFixtures/clientes.php';
foreach ($clientesData as $data) {
    $cliente = new Cliente(
        $data['nome'],
        new Email($data['email']),
        new Telefone($data['telefone']),
        ClienteTipo::fromString($data['tipo'])
    );
    
    $cliente->setEndereco($data['endereco'])
           ->setCidade($data['cidade'])
           ->setEstado($data['estado'])
           ->setCep($data['cep']);
    
    $entityManager->persist($cliente);
}
echo "âœ“ Clientes carregados\n";

// ServiÃ§os
$servicosData = require __DIR__ . '/DataFixtures/servicos.php';
foreach ($servicosData as $data) {
    $servico = new Servico($data['titulo'], $data['descricao'], $data['itens']);
    $servico->setIcone($data['icone'])->setGarantiaMeses($data['garantia_meses']);
    $entityManager->persist($servico);
}
echo "âœ“ ServiÃ§os carregados\n";

// TÃ©cnicos
$tecnicosData = require __DIR__ . '/DataFixtures/tecnicos.php';
foreach ($tecnicosData as $data) {
    $tecnico = new Tecnico(
        $data['nome'],
        new Email($data['email']),
        new Telefone($data['telefone'])
    );
    $tecnico->setEspecialidade($data['especialidade'])->setCor($data['cor']);
    $entityManager->persist($tecnico);
}
echo "âœ“ TÃ©cnicos carregados\n";

// UsuÃ¡rios
$usuariosData = require __DIR__ . '/DataFixtures/usuarios.php';
foreach ($usuariosData as $data) {
    $usuario = new Usuario(
        $data['nome'],
        new Email($data['email']),
        $data['senha'],
        UsuarioNivel::fromString($data['nivel'])
    );
    $entityManager->persist($usuario);
}
echo "âœ“ UsuÃ¡rios carregados\n";

$entityManager->flush();

// Agendamentos (apÃ³s flush para ter IDs)
$agendamentosData = require __DIR__ . '/DataFixtures/agendamentos.php';
foreach ($agendamentosData as $data) {
    $cliente = $entityManager->find(Cliente::class, $data['cliente_id']);
    $servico = $entityManager->find(Servico::class, $data['servico_id']);
    $tecnico = $entityManager->find(Tecnico::class, $data['tecnico_id']);
    
    if ($cliente && $servico && $tecnico) {
        $agendamento = new Agendamento(
            $data['titulo'],
            $cliente,
            $servico,
            $tecnico,
            new \DateTime($data['data_agendamento']),
            new \DateTime($data['hora_inicio'])
        );
        
        if (isset($data['hora_fim'])) {
            $agendamento->setHoraFim(new \DateTime($data['hora_fim']));
        }
        
        $agendamento->setValor($data['valor']);
        $agendamento->setStatus(AgendamentoStatus::fromString($data['status']));
        
        $entityManager->persist($agendamento);
    }
}
echo "âœ“ Agendamentos carregados\n";

// Contatos
$contatosData = require __DIR__ . '/DataFixtures/contatos.php';
foreach ($contatosData as $data) {
    $contato = new Contato(
        $data['nome'],
        new Email($data['email']),
        new Telefone($data['telefone']),
        $data['mensagem']
    );
    
    if (isset($data['servico_id'])) {
        $servico = $entityManager->find(Servico::class, $data['servico_id']);
        if ($servico) {
            $contato->setServico($servico);
        }
    }
    
    $contato->setStatus(ContatoStatus::fromString($data['status']));
    $entityManager->persist($contato);
}
echo "âœ“ Contatos carregados\n";

$entityManager->flush();

echo "\nğŸ‰ Fixtures carregadas com sucesso!\n";
echo "\nğŸ“Š Dados carregados:\n";
echo "ğŸ‘¥ Clientes: 5\n";
echo "ğŸ”§ ServiÃ§os: 4\n";
echo "ğŸ‘¨â€ğŸ”§ TÃ©cnicos: 4\n";
echo "ğŸ‘¤ UsuÃ¡rios: 4\n";
echo "ğŸ“… Agendamentos: 3\n";
echo "ğŸ“ Contatos: 3\n";
echo "\nğŸ“‹ Credenciais de Teste:\n";
echo "ğŸ‘¨ğŸ’¼ Admin: admin@simao.com / admin123\n";
echo "ğŸ”§ TÃ©cnico: carlos.silva@simao.com / tecnico123\n";
echo "\nğŸŒ Acesse: http://localhost:8000\n";